// ==UserScript==
// @name         IMG View Launcher Button
// @namespace    local.img.view.launcher
// @description  Add a bottom-left IMG button that launches img view.
// @version      1.5
// @match        *://*/*
// @noframes
// @grant        none
// ==/UserScript==

(() => {
  'use strict';

  const SCRIPT_REV = '1.5';
  const BTN_ID = '__imgViewLauncherBtn';
  const STYLE_ID = '__imgViewLauncherStyle';
  const BASE_BOTTOM_PX = 12;
  const STACK_GAP_PX = 6;
  const LEFT_ZONE_MAX_X_PX = 280;
  const LEFT_STACK_SELECTORS = ['#b2r-control-wrap', '#srm-reader-ui'];
  const BASE_LEFT_PX = 12;
  const LEFT_GAP_PX = 6;
  const FETCH_TIMEOUT_MS = 8000;
  const IMG_VIEW_SOURCE_URL = 'https://github.com/NF0730/public-JS/blob/main/img%20view%20b64%20latest.txt';

  if (document.getElementById(BTN_ID)) return;

  const css = `
#${BTN_ID}{
  position: fixed;
  left: calc(var(--ivlb-left, 12px) + env(safe-area-inset-left));
  bottom: calc(var(--ivlb-bottom, 12px) + env(safe-area-inset-bottom));
  z-index: 2147483647;
  border: 0;
  border-radius: 999px;
  padding: 7px 9px;
  min-width: 40px;
  text-align: center;
  color: #fff;
  font: 600 10px/1.1 -apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background: rgba(17,24,39,.88);
  -webkit-backdrop-filter: blur(8px);
  backdrop-filter: blur(8px);
  box-shadow: 0 2px 10px rgba(0,0,0,.25);
  max-width: min(52vw,200px);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  user-select: none;
}
#${BTN_ID}:active{ transform: translateY(1px); }
`;

  function mountNode() {
    return document.body || document.documentElement;
  }

  function ensureStyle() {
    if (document.getElementById(STYLE_ID)) return;
    const style = document.createElement('style');
    style.id = STYLE_ID;
    style.textContent = css;
    document.documentElement.appendChild(style);
  }

  function toast(msg) {
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.cssText = `
      position:fixed; left:50%; bottom:calc(18px + env(safe-area-inset-bottom));
      transform:translateX(-50%);
      z-index:2147483647;
      background:rgba(0,0,0,.75); color:#fff;
      padding:10px 12px; border-radius:14px;
      font:14px/1.1 -apple-system, system-ui, sans-serif;
      -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
    `;
    mountNode().appendChild(t);
    setTimeout(() => t.remove(), 1000);
  }

  function getVisibleLeftStackRects(vh) {
    const rects = [];
    for (let i = 0; i < LEFT_STACK_SELECTORS.length; i += 1) {
      const el = document.querySelector(LEFT_STACK_SELECTORS[i]);
      if (!el) continue;
      const r = el.getBoundingClientRect();
      if (r.width <= 0 || r.height <= 0) continue;
      if (r.left > LEFT_ZONE_MAX_X_PX || r.right < 0) continue;
      if (r.bottom < vh - 320) continue;
      rects.push(r);
    }
    return rects;
  }

  function calcButtonPosition(btn) {
    const vh = window.innerHeight || document.documentElement.clientHeight || 0;
    const vw = window.innerWidth || document.documentElement.clientWidth || 0;
    if (!vh) return { bottom: BASE_BOTTOM_PX, left: BASE_LEFT_PX };

    const rects = getVisibleLeftStackRects(vh);
    if (!rects.length) return { bottom: BASE_BOTTOM_PX, left: BASE_LEFT_PX };

    let top = null;
    let rightMost = null;
    for (let i = 0; i < rects.length; i += 1) {
      const r = rects[i];
      if (top === null || r.top < top) top = r.top;
      const fromBottom = vh - r.bottom;
      if (fromBottom <= BASE_BOTTOM_PX + 96) {
        if (rightMost === null || r.right > rightMost) rightMost = r.right;
      }
    }

    let bottom = BASE_BOTTOM_PX;
    if (top !== null) {
      bottom = Math.max(BASE_BOTTOM_PX, Math.ceil(vh - top + STACK_GAP_PX));
    }

    let left = BASE_LEFT_PX;
    if (rightMost !== null && bottom <= BASE_BOTTOM_PX + 1) {
      const btnWidth = (btn && btn.offsetWidth) || 40;
      const maxLeft = vw ? Math.max(BASE_LEFT_PX, vw - btnWidth - 12) : BASE_LEFT_PX;
      left = Math.min(maxLeft, Math.max(BASE_LEFT_PX, Math.ceil(rightMost + LEFT_GAP_PX)));
    }

    return { bottom, left };
  }

  function applyButtonPosition(btn) {
    if (!btn) return;
    const pos = calcButtonPosition(btn);
    btn.style.setProperty('--ivlb-bottom', `${pos.bottom}px`);
    btn.style.setProperty('--ivlb-left', `${pos.left}px`);
  }

  function runScriptText(s) {
    try {
      Function(s)();
    } catch {
      (0, eval)(s);
    }
  }

  function toRawGitHubUrl(url) {
    try {
      const u = new URL(url, location.href);
      if ((u.hostname === 'github.com' || u.hostname === 'www.github.com') && u.pathname.includes('/blob/')) {
        const parts = u.pathname.split('/').filter(Boolean);
        if (parts.length >= 5 && parts[2] === 'blob') {
          const owner = parts[0];
          const repo = parts[1];
          const ref = parts[3];
          const path = parts.slice(4).join('/');
          return `https://raw.githubusercontent.com/${owner}/${repo}/${ref}/${path}`;
        }
      }
      return u.href;
    } catch {
      return url;
    }
  }

  async function fetchScriptText(url, timeoutMs) {
    const controller = typeof AbortController === 'function' ? new AbortController() : null;
    const timer = controller ? setTimeout(() => controller.abort(), timeoutMs) : 0;
    try {
      const resp = await fetch(url, {
        method: 'GET',
        cache: 'no-store',
        credentials: 'omit',
        signal: controller ? controller.signal : undefined
      });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return await resp.text();
    } finally {
      if (timer) clearTimeout(timer);
    }
  }

  async function runImgViewFromUrl() {
    const src = toRawGitHubUrl(IMG_VIEW_SOURCE_URL);
    const s = await fetchScriptText(src, FETCH_TIMEOUT_MS);
    runScriptText(s);
  }

  function init() {
    if (document.getElementById(BTN_ID)) return;
    ensureStyle();

    const btn = document.createElement('button');
    btn.id = BTN_ID;
    btn.type = 'button';
    btn.textContent = 'IMG';
    btn.dataset.rev = SCRIPT_REV;
    mountNode().appendChild(btn);
    applyButtonPosition(btn);
    setTimeout(() => applyButtonPosition(btn), 300);
    setTimeout(() => applyButtonPosition(btn), 1200);
    window.addEventListener('resize', () => applyButtonPosition(btn), { passive: true });
    window.addEventListener('orientationchange', () => applyButtonPosition(btn), { passive: true });
    document.addEventListener('click', () => setTimeout(() => applyButtonPosition(btn), 0), true);

    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      applyButtonPosition(btn);
      try {
        await runImgViewFromUrl();
      } catch (err) {
        console.error('[img-view-launcher]', err);
        toast('IMG起動に失敗しました');
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once: true });
  } else {
    init();
  }
})();
